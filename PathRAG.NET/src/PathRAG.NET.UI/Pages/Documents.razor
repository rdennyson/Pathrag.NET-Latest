@page "/documents"
@inject IDocumentService DocumentService
@inject MessageService MessageService

<PageTitle>Documents - PathRAG.NET</PageTitle>

@* Page Header *@
<Card Bordered="false" Style="margin-bottom: 24px;">
    <Row Justify="space-between" Align="middle">
        <Col>
            <div style="display: flex; align-items: center; gap: 16px;">
                <Avatar Size="48" Style="background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);">
                    <Icon Type="folder-open" Style="font-size: 24px;" />
                </Avatar>
                <div>
                    <Title Level="4" Style="margin: 0;">Document Management</Title>
                    <Text Type="secondary">Upload, manage, and process your documents for knowledge extraction</Text>
                </div>
            </div>
        </Col>
        <Col>
            <Space>
                <SpaceItem>
                    <Button OnClick="@LoadDocuments" Icon="@IconType.Outline.Reload">
                        Refresh
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Primary" Icon="@IconType.Outline.Upload" OnClick="@(() => _uploadVisible = true)">
                        Upload Document
                    </Button>
                </SpaceItem>
            </Space>
        </Col>
    </Row>
</Card>

@* Statistics Row *@
<Row Gutter="(16, 16)" Style="margin-bottom: 24px;">
    <Col Xs="24" Sm="8">
        <Card Bordered="false" Size="small">
            <Statistic Title="Total Documents" Value="@(_documents?.Count() ?? 0)">
                <PrefixTemplate>
                    <Icon Type="file" Style="color: #1890ff;" />
                </PrefixTemplate>
            </Statistic>
        </Card>
    </Col>
    <Col Xs="24" Sm="8">
        <Card Bordered="false" Size="small">
            <Statistic Title="Completed" Value="@(_documents?.Count(d => d.Status.ToLower() == "completed") ?? 0)"
                       ValueStyle="color: #52c41a">
                <PrefixTemplate>
                    <Icon Type="check-circle" Style="color: #52c41a;" />
                </PrefixTemplate>
            </Statistic>
        </Card>
    </Col>
    <Col Xs="24" Sm="8">
        <Card Bordered="false" Size="small">
            <Statistic Title="Processing" Value="@(_documents?.Count(d => d.Status.ToLower() == "processing") ?? 0)"
                       ValueStyle="color: #1890ff">
                <PrefixTemplate>
                    <Icon Type="sync" Spin Style="color: #1890ff;" />
                </PrefixTemplate>
            </Statistic>
        </Card>
    </Col>
</Row>

@* Document List *@
<Card Bordered="false">
    @if (_loading)
    {
        <div style="text-align: center; padding: 60px;">
            <Spin Size="large" Tip="Loading documents..." />
        </div>
    }
    else if (_documents == null || !_documents.Any())
    {
        <div class="empty-state">
            <div class="empty-state-icon">
                <Icon Type="inbox" />
            </div>
            <div class="empty-state-title">No Documents Yet</div>
            <div class="empty-state-description">
                Upload your first document to start building your knowledge graph.<br/>
                Supported formats: PDF, DOCX, TXT, MD, HTML
            </div>
            <Button Type="@ButtonType.Primary" Size="large" OnClick="@(() => _uploadVisible = true)">
                <Icon Type="upload" /> Upload Your First Document
            </Button>
        </div>
    }
    else
    {
        <Table TItem="DocumentDto" DataSource="@_documents" Size="@TableSize.Middle"
               Bordered="false" ScrollX="800">
            <Column TData="string" Title="Document" Width="300">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <Avatar Size="40" Style="@($"background-color: {GetFileColor(context.Name)}; flex-shrink: 0;")">
                        <Icon Type="@GetFileIcon(context.Name)" />
                    </Avatar>
                    <div style="min-width: 0;">
                        <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            @context.Name
                        </div>
                        <div style="font-size: 12px; color: rgba(0,0,0,0.45);">
                            @GetFileExtension(context.Name).ToUpper() File
                        </div>
                    </div>
                </div>
            </Column>
            <PropertyColumn Property="c => c.Status" Title="Status" Width="120">
                <Tag Color="@GetStatusColor(context.Status)" Style="margin: 0;">
                    @if (context.Status.ToLower() == "processing")
                    {
                        <Icon Type="sync" Spin />
                    }
                    @context.Status
                </Tag>
            </PropertyColumn>
            <Column TData="long" Title="Size" Width="100">
                @FormatFileSize(context.FileSize)
            </Column>
            <Column TData="int" Title="Chunks" Width="100">
                <Badge Count="@context.ChunkCount" Style="background-color: #1890ff;" ShowZero />
            </Column>
            <Column TData="DateTimeOffset" Title="Uploaded" Width="150">
                <Tooltip Title="@context.CreationDate.ToString("yyyy-MM-dd HH:mm:ss")">
                    @context.CreationDate.ToString("MMM dd, yyyy")
                </Tooltip>
            </Column>
            <ActionColumn Title="Actions" Width="120" Fixed="right">
                <Space>
                    <SpaceItem>
                        <Tooltip Title="@("View Details")">
                            <Button Type="@ButtonType.Text" Icon="@IconType.Outline.Eye" Size="small" />
                        </Tooltip>
                    </SpaceItem>
                    <SpaceItem>
                        <Popconfirm Title="Are you sure you want to delete this document?"
                                    OnConfirm="@(() => DeleteDocument(context.Id))"
                                    OkText="Delete"
                                    CancelText="Cancel"
                                    Placement="@Placement.Left">
                            <Tooltip Title="@("Delete")">
                                <Button Type="@ButtonType.Text" Danger Icon="@IconType.Outline.Delete" Size="small" />
                            </Tooltip>
                        </Popconfirm>
                    </SpaceItem>
                </Space>
            </ActionColumn>
        </Table>
    }
</Card>

@* Upload Modal *@
<Modal Title="@("Upload Document")"
       Visible="@_uploadVisible"
       OnCancel="@CloseUploadModal"
       Width="520"
       Footer="null">
    <div style="padding: 8px 0;">
        @* Always keep InputFile in DOM to preserve file reference *@
        <InputFile @key="_inputFileKey" id="file-upload-input" OnChange="@OnFileSelected"
                   accept=".pdf,.docx,.txt,.md,.html"
                   style="display: none;" />

        @if (_selectedFile == null)
        {
            <label class="upload-area" for="file-upload-input" style="cursor: pointer; display: block;">
                <div class="upload-icon">
                    <Icon Type="cloud-upload" />
                </div>
                <div class="upload-text">Click or drag file to upload</div>
                <div class="upload-hint">
                    Supports PDF, DOCX, TXT, MD, HTML files up to 50MB
                </div>
            </label>
        }
        else
        {
            <Card Bordered Style="margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <Avatar Size="48" Style="@($"background-color: {GetFileColor(_selectedFile.Name)}")">
                        <Icon Type="@GetFileIcon(_selectedFile.Name)" Style="font-size: 24px;" />
                    </Avatar>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            @_selectedFile.Name
                        </div>
                        <div style="font-size: 13px; color: rgba(0,0,0,0.45);">
                            @FormatFileSize(_selectedFile.Size) â€¢ @GetFileExtension(_selectedFile.Name).ToUpper()
                        </div>
                    </div>
                    <Button Type="@ButtonType.Text" Icon="@IconType.Outline.Close"
                            OnClick="@ClearSelectedFile" />
                </div>
            </Card>

            <Alert Type="@AlertType.Info" ShowIcon="true"
                   Message="Ready to upload"
                   Description="The document will be processed automatically after upload. Entity extraction and knowledge graph building may take a few minutes." />

            <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                <Button OnClick="@CloseUploadModal">Cancel</Button>
                <Button Type="@ButtonType.Primary"
                        Loading="@_uploading"
                        OnClick="@UploadFile"
                        Icon="@IconType.Outline.Upload">
                    Upload and Process
                </Button>
            </div>
        }
    </div>
</Modal>

@code {
    private IEnumerable<DocumentDto>? _documents;
    private bool _loading = true;
    private bool _uploadVisible;
    private bool _uploading;
    private IBrowserFile? _selectedFile;
    private Guid _inputFileKey = Guid.NewGuid();

    protected override async Task OnInitializedAsync()
    {
        await LoadDocuments();
    }

    private async Task LoadDocuments()
    {
        _loading = true;
        StateHasChanged();
        _documents = await DocumentService.GetDocumentsAsync();
        _loading = false;
        StateHasChanged();
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        StateHasChanged();
    }

    private void ClearSelectedFile()
    {
        _selectedFile = null;
        _inputFileKey = Guid.NewGuid(); // Reset the InputFile component
    }

    private void CloseUploadModal()
    {
        _uploadVisible = false;
        _selectedFile = null;
        _inputFileKey = Guid.NewGuid(); // Reset the InputFile component
    }

    private async Task UploadFile()
    {
        if (_selectedFile == null) return;

        _uploading = true;
        try
        {
            using var stream = _selectedFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
            await DocumentService.UploadDocumentAsync(stream, _selectedFile.Name, _selectedFile.ContentType);
            await MessageService.Success("Document uploaded successfully! Processing will begin shortly.");
            _uploadVisible = false;
            _selectedFile = null;
            await LoadDocuments();
        }
        catch (Exception ex)
        {
            await MessageService.Error($"Upload failed: {ex.Message}");
        }
        finally
        {
            _uploading = false;
        }
    }

    private async Task DeleteDocument(Guid id)
    {
        var success = await DocumentService.DeleteDocumentAsync(id);
        if (success)
        {
            await MessageService.Success("Document deleted successfully");
            await LoadDocuments();
        }
        else
        {
            await MessageService.Error("Failed to delete document");
        }
    }

    private static string GetStatusColor(string status) => status.ToLower() switch
    {
        "completed" => "success",
        "processing" => "processing",
        "failed" => "error",
        "pending" => "warning",
        _ => "default"
    };

    private static string GetFileIcon(string fileName)
    {
        var ext = Path.GetExtension(fileName)?.ToLower();
        return ext switch
        {
            ".pdf" => "file-pdf",
            ".doc" or ".docx" => "file-word",
            ".txt" => "file-text",
            ".md" => "file-markdown",
            ".html" or ".htm" => "html5",
            _ => "file"
        };
    }

    private static string GetFileColor(string fileName)
    {
        var ext = Path.GetExtension(fileName)?.ToLower();
        return ext switch
        {
            ".pdf" => "#ff4d4f",
            ".doc" or ".docx" => "#1890ff",
            ".txt" => "#52c41a",
            ".md" => "#722ed1",
            ".html" or ".htm" => "#fa8c16",
            _ => "#8c8c8c"
        };
    }

    private static string GetFileExtension(string fileName)
    {
        return Path.GetExtension(fileName)?.TrimStart('.') ?? "file";
    }

    private static string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        int order = 0;
        double size = bytes;
        while (size >= 1024 && order < sizes.Length - 1) { order++; size /= 1024; }
        return $"{size:0.##} {sizes[order]}";
    }
}

